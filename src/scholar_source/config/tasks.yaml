course_analysis_task:
  description: >
    Analyze course/book info to identify academic discipline and topics. CRITICAL: correctly identify field to prevent off-topic resources.

    **DEPTH RESTRICTION - VERY IMPORTANT:**
    - ONLY navigate to the main course page URL provided by the user
    - If a syllabus link is found on the main page, you MAY navigate to that ONE additional link (syllabi often contain textbook and topic info)
    - DO NOT navigate to any other links (lecture notes, assignments, problem sets, etc.) to avoid redirect loops
    - However, DO extract and list ALL resource URLs found on the course page and syllabus (lecture notes, problem sets, exams, videos, etc.)
    - These extracted URLs will be used by other agents to find relevant study materials
    - This prevents infinite redirect loops while still capturing all course resources

    **TOOL USAGE:**
    1. Use "Webpage Content Fetcher" tool to fetch the full text content of the course URL
    2. Search the fetched content for textbook information
    3. Only use WebsiteSearchTool if you need to search within the page after fetching

    **TEXTBOOK EXTRACTION - CRITICAL:**
    1. Fetch course page using "Webpage Content Fetcher" tool with the course_url
    2. In the fetched content, look for textbook information with these patterns:
       - "Textbook:" or "Text:" or "Required text:" or "Required textbook:"
       - "Book:" or "Required book:"
       - Look in sections labeled "Materials", "Required Materials", "Course Materials", "Resources"
    3. The textbook info may appear on the same line, next line, or in nearby lines
    4. Common formats to handle:
       - "Textbook: Title, Author1, Author2"
       - "Text: Title by Author"
       - "Textbook: Title. Author."
       - "Title (Author)"
       - "Author1, Author2, Title" (author-first format)
       - Multi-line format where title is on one line and author on the next (or vice versa)
    5. Parsing rules (try in order):
       - If line contains " by " ‚Üí split at " by ": before = title, after = author
       - If line has format "Title (Author)" ‚Üí extract both
       - If comma-separated AND contains ":" in textbook context ‚Üí Look for common author last names (Bedford, Fowler, etc.) at START of text after colon
         * If first word looks like author name (capitalized, common last name) ‚Üí everything before last comma = author, after = title
         * Otherwise ‚Üí First part before first comma = title, rest = author
       - If period-separated ‚Üí Before first/second period = title, after = author
       - If spread across lines ‚Üí Look for author patterns (names, "by", "Author:") and title patterns (colons in titles like "Engineering Mechanics: Statics")
    6. Return separate textbook_title and textbook_author fields
    7. Also look for syllabus links (may be relative URLs like "../documents/syllabus.pdf")

    **SYLLABUS:** If you find a syllabus link, convert relative URLs to absolute URLs using the course page domain.
    You SHOULD fetch the syllabus ONCE using "Webpage Content Fetcher" whether it's HTML or PDF - syllabi are the authoritative source for textbook and topic info.
    Extract textbook info and topics from syllabus.

    **CRITICAL - NARROW TOPIC SCOPE:** When extracting topics from the syllabus:
    - ONLY include topics/chapters that are explicitly referenced in the syllabus schedule/outline
    - If syllabus says "Chapters 1-5" or "Sections 3.1-3.4", ONLY include those specific chapters/sections
    - If syllabus lists specific topics by name (e.g., "Week 1: Vectors, Week 2: Forces"), ONLY include those topics
    - DO NOT include all chapters from the textbook table of contents - only what the syllabus actually covers
    - This ensures resource search is focused on what the course actually teaches, not the entire textbook

    **TEXTBOOK TABLE OF CONTENTS:** If you found a textbook title and author, you may search the web
    for "[title] [author] table of contents" to get chapter topics (optional, only if needed for topics).
    IMPORTANT: If you have a syllabus, cross-reference the ToC with the syllabus to identify ONLY the chapters/sections the course covers.

    **TOPICS:**
    - **IF user provided topics_list:** Use those topics as PRIMARY focus. Still identify general course subject, but mark user topics as the priority search targets.
    - **IF NO topics_list:** Extract topics ONLY from what the course actually covers (syllabus schedule, course description). DO NOT include all textbook chapters.
    - **PRIORITY ORDER for topic extraction:**
      1. Syllabus schedule/outline (most authoritative - shows what course actually covers)
      2. Course description/overview (shows course focus)
      3. Textbook ToC cross-referenced with syllabus (ONLY chapters/sections the syllabus references)
    - **BE SPECIFIC:** If syllabus says "Chapters 3-7", map those to actual chapter titles from ToC (e.g., "Forces", "Equilibrium", "Structures", "Friction", "Virtual Work")
    - Always include both user_specified_topics (if any) and general_course_topics in output so downstream agents know what to prioritize.

    **ERROR IF:** Zero topics AND no textbook found AND no course description ‚Üí "ERROR: Cannot determine course topics. Provide textbook PDF or topics list."

    **IMPORTANT:** Focused topics lead to better resource matching. A course covering "Chapters 1-5" should have 5 topic areas, not 15.

    Inputs: {university_name}, {course_name}, {course_url}, {textbook}, {topics_list}, {book_title}, {book_author}, {isbn}, {book_pdf_path}, {book_url}, {desired_resource_types}
  expected_output: >
    A structured analysis containing:

    - course_title: The course name from the course page (e.g., "Engineering Analysis II")
    - course_number: The course number (e.g., "GEN_ENG 205-2")
    - textbook_title: Full textbook title (e.g., "Engineering Mechanics: Statics") - REQUIRED if found on page
    - textbook_author: Author name(s) (e.g., "Bedford, Fowler") - REQUIRED if found on page
    - textbook_edition: Edition if specified (e.g., "5th edition")
    - textbook_isbn: ISBN if found
    - textbook_source: Where textbook info came from ("course_page", "user_provided", "not_found")
    - syllabus_url: URL to syllabus if found on course page
    - user_specified_topics: Topics from user's topics_list input (e.g., ["line integrals", "surface integrals"]) - EMPTY if not provided
    - general_course_topics: Comprehensive list of ALL topics from textbook ToC, syllabus, course page
      (e.g., ["Vectors", "Forces", "Systems of Forces and Moments", "Equilibrium", "Structures",
      "Centroids", "Centers of Mass", "Moments of Inertia", "Friction", "Internal Forces", "Virtual Work"])
    - search_priority: "user_topics" if user_specified_topics is non-empty, otherwise "general_topics"
    - course_level: "introductory" | "intermediate" | "advanced" | "professional"
    - subject_keywords: List of keywords describing the subject based on topics (e.g., ["statics", "mechanics", "forces", "equilibrium"])

    **CRITICAL OUTPUT REQUIREMENT:**
    After running ALL WebsiteSearchTool queries, examine the results for textbook information:
    - Look for book titles containing colons (e.g., "Engineering Mechanics: Statics")
    - Look for author last names (e.g., "Bedford", "Fowler")
    - If you see BOTH together (e.g., "Engineering Mechanics: Statics, Bedford, Fowler"), parse into separate fields
    - Split by first comma: everything before = title, everything after = author(s)
    - You MUST output textbook_title and textbook_author if found, even if format is ambiguous
    - If uncertain about parsing, include both fields with your best interpretation
    - These fields are CRITICAL for the frontend display

    Format as a clean JSON object or structured text that subsequent agents can easily parse.
  agent: course_intelligence_agent

resource_search_task:
  description: >
    Search for 5-7 high-quality resources from USA-based institutions matching the course topics.

    **TOPIC MATCHING - CRITICAL:** Check search_priority from course_analysis_task output:
    - **IF search_priority = "user_topics":** Focus EXCLUSIVELY on user_specified_topics. Search for resources specifically covering those topics.
      Example: User specified "line integrals, surface integrals" ‚Üí search "line integrals practice problems" and "surface integrals tutorial", NOT general "vector calculus"
    - **IF search_priority = "general_topics":** Search for resources covering the general_course_topics
    - Always verify resources match the course's subject_keywords to avoid cross-discipline contamination
    - REJECT any resource from a different academic field (e.g., don't match statistics resources for a calculus course, don't match biology resources for a history course)
    - Verify the course title/description matches the subject area before including it

    **USA ONLY:** Only include resources from US universities, institutions, and platforms.

    **RESOURCE TYPE FILTERING:** Check {desired_resource_types} input.
    - If provided (non-empty list), ONLY search for matching types:
      * "textbooks" ‚Üí resource_type="open_textbook"
      * "practice_problem_sets" ‚Üí resource_type="practice_problem" or "problem_set"
      * "practice_exams_tests" ‚Üí resource_type="practice_exam" or "test"
      * "lecture_videos" ‚Üí resource_type="video_lecture" or "lecture_series" or "educational_video"
    - If empty/null, use priority order: (1) Practice problems, (2) Open textbooks, (3) Course materials, (4) Platform content, (5) Papers

    **SEARCH TOOL USAGE - CRITICAL:**
    You have access to "Search the internet with Serper" tool. 
    - Call the tool with ONLY a string value for search_query parameter
    - Example: search_query="statics practice problems MIT"
    - DO NOT pass dictionaries, objects, or complex structures
    - DO NOT pass description, metadata, or other fields - ONLY the search_query string
    - Perform 5-7 targeted searches, each with a simple string query

    **QUALITY:** Free, legal, US sources only. NotebookLM compatible (PDF/web/YouTube). Prioritize text-based content. Match course level.

    Use course_analysis_task output to guide searches.
  expected_output: >
    A curated list of 5-7 recommended resources that complement the student's book, each containing:
    
    - resource_title: Full title of the resource
    - resource_type: "open_textbook" | "video_lecture" | "lecture_series" | 
      "interactive_tutorial" | "course_notes" | "educational_video"
    - url: Direct link to the resource (must be accessible without login)
    - coverage_topics: List of book topics/chapters this resource addresses
    - source_credibility: Origin (e.g., "MIT OpenCourseWare", "OpenStax", "Khan Academy")
    - content_scope: "comprehensive" | "supplementary" | "topic-specific"
    - access_notes: Confirmation that it's free, legal, and openly accessible
    - estimated_depth: "introductory" | "intermediate" | "advanced"
    - alignment_with_book: Brief note on how this resource aligns with the book's structure

    Organize resources clearly. Include brief reasoning for why each resource was selected
    and how it complements the student's book.
  agent: resource_discovery_agent

resource_validation_task:
  description: >
    Validate resources from resource_discovery_agent for quality, legal, and technical requirements.

    **CRITICAL - URL VALIDATION USING WEB SEARCH:**
    Before validating any resource, you MUST verify each URL actually exists and is accessible:
    1. For EVERY resource URL, perform a web search query: "[exact URL]" OR "site:[domain] [page title]"
    2. Check if the search results show the page exists and is accessible
    3. REJECT immediately if:
       - Search results show 404 errors or "page not found"
       - No search results found for the exact URL
       - Search results indicate the page was removed or moved
       - Domain doesn't exist or returns errors
    4. This prevents returning dead/broken links to users

    **CHECKS (EFFICIENT - MINIMIZE API CALLS):**
    1. URL format check: Verify URL structure (PDFs end in .pdf, YouTube URLs contain youtube.com, etc.)
    2. **URL ACCESSIBILITY (CRITICAL):** For web resources, verify the URL is actually valid:
       - Check for common 404 patterns and incomplete URLs
       - REJECT any URL that appears truncated or incomplete (e.g., ends abruptly without proper path)
       - LibreTexts URLs: Must be complete paths like "math.libretexts.org/Bookshelves/Calculus/Calculus_(OpenStax)/[chapter]/[section]"
         * REJECT if URL ends with incomplete path like "/Calculus_(OpenStax" or "/Bookshelves/Calculus/Calculus_(OpenStax"
         * Must have full chapter and section path to be valid
       - OpenStax: Use URLs like "openstax.org/books/[book-name]" NOT "openstax.org/details/books/[book-name]"
       - MIT OCW: Verify URLs follow pattern "ocw.mit.edu/courses/[department]/[course-number]-[course-name]-[semester]-[year]/"
         * REJECT incomplete MIT OCW URLs that don't include full course path
       - Personal/Faculty PDFs: Be extra cautious - many faculty members remove old course materials
         * For URLs like "utsa.edu/kalra/..." or similar personal faculty pages, perform web search to verify still exists
         * REJECT if web search shows 404 or page not found
       - Udacity, Coursera, edX: REJECT ALL (require accounts)
       - If URL looks suspicious, incomplete, or uses an uncommon format, perform a quick web search to verify the correct URL
       - Reject resources with clearly broken, incomplete, or non-existent URLs
    3. **LOGIN REQUIREMENTS (CRITICAL - AUTO-REJECT):**
       - Khan Academy: REJECT ALL (requires login)
       - Coursera: REJECT ALL (requires account)
       - Udemy: REJECT ALL (paid)
       - edX: REJECT ALL (requires account)
       - Udacity: REJECT ALL (requires account)
       - Brilliant.org: REJECT ALL (paid subscription)
       - Any site requiring authentication
    4. NotebookLM compatibility: Check format from URL extension and resource_type (PDF/web/YouTube)
    5. Source credibility: Verify from URL domain and source_credibility field (MIT OCW, OpenStax, etc.)
    6. **TOPIC RELEVANCE (CRITICAL):** Resource MUST match the course subject area
       - PRIMARY: Use resource_title, coverage_topics, and source_credibility from previous task to verify relevance
       - ONLY use WebsiteSearchTool if absolutely necessary (e.g., title is ambiguous) - LIMIT to 1-2 calls maximum
       - For PDFs: Verify from URL, title, and source - DO NOT use WebsiteSearchTool on PDFs
       - For YouTube: Verify from video title and channel - DO NOT use WebsiteSearchTool unless title is unclear
       - For web pages: Only use WebsiteSearchTool if title/topics don't clearly indicate relevance
       - For Vector Calculus course ‚Üí REJECT probability, statistics, or unrelated math resources
       - For Renaissance History course ‚Üí REJECT modern history, art history, or unrelated humanities resources
       - Most validation should be done from metadata already provided, not by making additional API calls

    **REMOVE:** Requires payment/login, pirated, broken links, low quality, incompatible, OR WRONG SUBJECT AREA.

    **SCORE:** Rate usefulness 1-10: relevance (40%), comprehensiveness (30%), credibility (20%), usability (10%).
    - Relevance score MUST be 0 if the resource is for a different academic field or discipline

    Use resources from previous task.
  expected_output: >
    A filtered and validated list of resources, each containing:
    
    - All original resource fields from the search task
    - validation_status: "approved" | "rejected"
    - rejection_reason: Detailed explanation if rejected
    - notebooklm_compatible: true | false
    - notebooklm_format: "pdf" | "youtube" | "webpage" | "not_compatible"
    - license_info: Copyright/license information found
    - accessibility_verified: true | false
    - usefulness_score: 1-10 (integer)
    - validation_notes: Any important notes about the resource
    
    **Summary Statistics:**
    - Total resources validated: X
    - Approved: X
    - Rejected: X
    - Average usefulness score: X.X
    
    Only include APPROVED resources in the final list. Aim for 5-7 high-quality 
    approved resources total. If fewer than 5 pass validation, note this in the output.
  agent: resource_validator_agent

final_output_task:
  description: >
    Create student-friendly resource guide for NotebookLM use.

    **STRUCTURE:**
    1. Textbook info - Extract from course_analysis_task output:
       - Use textbook_title and textbook_author fields if present
       - Use textbook_source to indicate where it was found
       - If textbook info is missing, note that no textbook was specified
    2. Course overview (description, topics)
    3. **IF user_specified_topics were provided:** Add a clear note that resources were specifically searched for those topics (e.g., "These resources focus on your specified topics: line integrals, surface integrals")
    4. Resources (organized by type/topic, with URLs, descriptions, topics covered)
    5. NotebookLM instructions (how to add PDFs/videos/web pages)
    6. Study tips (workflow, features)

    **FORMAT:** Clear headers, clickable URLs, bullet points, 2-4 pages. Tone: encouraging, clear, action-oriented.

    **CRITICAL:** Check the course_analysis_task output for textbook_title and textbook_author fields. If they exist, include them in the Textbook Information section. If they don't exist, state "No textbook information was found."

    Use validated resources and course analysis from previous tasks.
  expected_output: >
    A formatted markdown document ready to present to the student:

    # Study Resources for [Course Name]

    ## Textbook Information
    **Textbook:** [Book Title]
    **Author:** [Author Name(s)]
    **Source:** [Where found - e.g., "Course Page", "User Provided"]

    (If no textbook found, omit this section)

    ---

    ## üìö Course Overview
    [2-3 sentence description of what this course covers and what students will learn]

    **Key Topics:**
    - Topic 1
    - Topic 2
    - Topic 3
    [etc.]

    ---
    
    ## üéØ Recommended Resources
    
    I've found [X] high-quality, free resources to supplement your learning:
    
    ### [Topic Area 1] or [Resource Type 1]
    
    **1. [Resource Title]** (Type: Textbook/Video/etc.)
    - **Link:** [Direct URL]
    - **What it covers:** [Brief description highlighting value]
    - **Best for:** [When/how to use this resource]
    - **Usefulness Score:** ‚≠êÔ∏è [X/10]
    
    **2. [Next resource]**
    [Same format]
    
    ### [Topic Area 2] or [Resource Type 2]
    [Continue...]
    
    ---
    
    ## üì• How to Add These to NotebookLM
    
    **For PDFs:**
    1. Click the link to open the PDF
    2. In NotebookLM, click "+ New Source"
    3. Select "Upload" and choose the PDF file
    
    **For YouTube Videos:**
    1. Copy the YouTube URL
    2. In NotebookLM, click "+ New Source"
    3. Select "YouTube URL" and paste the link
    
    **For Web Pages:**
    1. Copy the webpage URL
    2. In NotebookLM, click "+ New Source"
    3. Select "Website URL" and paste the link
    
    ---
    
    ## üí° Study Tips
    
    **Using Multiple Sources:**
    - [Tip 1]
    - [Tip 2]
    - [Tip 3]
    
    **Maximizing NotebookLM:**
    - Use the chat feature to ask questions across all sources
    - Generate study guides from multiple perspectives
    - Create flashcards from the combined knowledge base
    - Use the audio overview feature to hear key concepts explained
    
    ---
    
    **Total Resources:** [X] carefully vetted, free, and legal educational materials
    
    **Need More Help?** [Optional: suggestions for finding additional resources]
    
    ---
    
    *All resources are freely and legally accessible. No pirated content included.*
  agent: output_formatter_agent