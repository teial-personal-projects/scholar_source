course_analysis_task:
  description: >
    Analyze a university course to extract textbook information, topics, and resource URLs.

    PRIMARY OBJECTIVE (MANDATORY):
    Identify the main textbook_title and textbook_author for the course.

    1. Find course_url (when only course_name + university_name given):
          - Use "Website Search Tool" to search the web to find the official course page URL.
          - Construct search queries combining:
            - Exact course_name AND
            - university_name, AND
            - Keywords: "syllabus" OR "course description" OR "course catalog"
          
          - Examine top 5-10 search results
          - PREFER URLs that contain ALL of these signals:
            * Course name or part of course namem in title (e.g., "/228-2", "math-228")
            * Example: For course Math 228-2, this name in the tile is acceptable: 228-2-1
            * Keywords in URL: "courses", "syllabus", "catalog", "class"
            * University's official domain (*.edu or official domain)
          
          - VALIDATE candidate page before accepting as course_url:
            * Fetch the page using "Webpage Content Fetcher"
            * Verify page content includes:
              - Course name/number matching input
              - At least TWO of: "Textbook", "Text:", "Prerequisites", "Syllabus", "Topics", "Description", "Instructor"
            * If page only contains department info/news/general content ‚Üí reject and try next candidate
          
          - Try up to 3 search queries and validate top 2 candidates from each
          - If no valid course page found after validation, return ERROR with guidance to provide course_url directly

    2) Use user-provided textbook info (if available):
       - If {book_title} and {book_author} are provided:
         - Use them and set textbook_source="user_provided".
       - If {isbn} is provided, optionally confirm title/author.
       - If {book_pdf_path} or {book_url} is provided, record for downstream agents.
       - If {textbook} is provided, parse for title/author.

    3) Fetch and verify course page:
       - If course_url is provided or found, use "Webpage Content Fetcher" on it.
       - Treat a page as the official course page ONLY if:
         - It clearly mentions this course_name and/or course number
           (e.g., "Math 228-2" or close variant), AND
         - It contains a course description, syllabus, requirements, or schedule.
       - Ignore global navigation (menus like "About", "People", "Events",
         "News", "Undergraduate Program", "Make a Gift", search boxes, etc.)
         and focus on central course content.
       - If no course_name and no course description/syllabus are found:
         - Do NOT extract textbook info.
         - Return an error asking the user to provide course_url directly.
       - On a confirmed course page, search for textbook info in sections such as
         "Materials", "Textbook", "Required Text", "Course Materials", "Resources".
       - Parse common formats like "Title, Author", "Title by Author",
         or multi-line title/author into textbook_title and textbook_author.

    4) Extract syllabus and topics:
       - If a syllabus link (HTML or PDF) exists, convert relative URL to absolute
         and fetch it once with "Webpage Content Fetcher".
       - Treat the syllabus as authoritative for textbook info and topics.
       - If topics_list is provided, treat as user_specified_topics (main focus).
       - Otherwise, extract topics from syllabus schedule/outline and course description.
       - If a textbook table of contents is available, align with syllabus to keep
         only chapters actually covered.

    5) Extract resource URLs:
       - Collect URLs for lecture notes, problem sets, exams, videos, and other
         course resources from the course page/syllabus.
       - Do NOT navigate to these links; just record them.

    DEPTH RESTRICTION:
    - Only visit the main course page and, if present, the syllabus.

    ERROR HANDLING:
    - If the course page is not accessible, return a clear error.
    - If no textbook is found on page/syllabus and none is provided, set
      textbook_source="not_found" but still extract topics if possible.
    - If there are no topics, no textbook, and no usable description, ask the
      user for topics_list or a textbook PDF/URL.

    Inputs: {university_name}, {course_name}, {course_url}, {textbook}, {topics_list},
            {book_title}, {book_author}, {isbn}, {book_pdf_path}, {book_url},
            {desired_resource_types}, {targeted_sites}

  expected_output: >
    JSON-like object with:

    Required fields:
    - course_title: Course name from page (or null).
    - course_number: Course code (or null).
    - textbook_title: Main textbook title (null if not found).
    - textbook_author: Main textbook author(s) (null if not found).
    - textbook_source: "course_page" | "user_provided" | "not_found".
    - search_priority: "user_topics" | "general_topics"
      (based on whether topics_list is provided).

    Topic fields:
    - user_specified_topics: Array from topics_list (empty if none).
    - general_course_topics: Array from syllabus/description.
    - subject_keywords: Short keyword list describing the discipline.

    Optional fields:
    - textbook_edition: Edition if available.
    - textbook_isbn: ISBN if found.
    - syllabus_url: URL of the syllabus if found.
    - resource_urls: List of resource links from course page/syllabus.
    - course_level: "introductory" | "intermediate" | "advanced" if inferable.

    Return clean JSON or clearly structured text that downstream agents can parse.

  agent: course_intelligence_agent


resource_search_task:
  description: >
    Search for 5-7 high-quality resources from USA-based sources matching the course topics and user preferences.

    **WORKFLOW:**
    1. Parse user filters from inputs
    2. Determine search focus from course_analysis_task output
    3. Execute targeted searches (USA sources only)
    4. Filter and validate results (reject non-USA sources)
    5. Return curated list

    **USA-ONLY REQUIREMENT:**
    ALL resources must be from USA-based institutions, universities, or platforms.
    - Accept: MIT, Stanford, Berkeley, OpenStax, US university sites
    - REJECT: Cambridge.ac.uk, Oxford.ac.uk, any non-US institution
    - When searching, include USA university names or add "USA" to queries
    - Verify domain and institution location before including any resource

    **PLATFORM RESTRICTIONS (DO NOT SEARCH OR INCLUDE):**
    NEVER include resources from these platforms (require login/payment):
    - Khan Academy (khanacademy.org) - requires login
    - Coursera (coursera.org) - requires account
    - Udemy (udemy.com) - paid courses
    - edX (edx.org) - requires account
    - Udacity (udacity.com) - requires account
    - Brilliant.org - paid subscription
    - Course platforms: *.thinkific.com, *.teachable.com, *.podia.com
    
    REJECT any URL containing: /premium/, /pro/, /subscription/, /members-only/
    
    Only recommend publicly accessible resources with NO login or payment required.

    **USER FILTERS (APPLY AFTER USA AND PLATFORM CHECKS):**
    
    Targeted Sites (if {targeted_sites} provided):
    - Parse as comma-separated domains (e.g., "stanford.edu, berkeley.edu")
    - Prioritize resources from these sites using "site:[domain]" in searches
    - Aim for 2-3 resources from targeted sites if quality matches
    
    Excluded Sites (if {excluded_sites} provided):
    - Parse as comma-separated domains (e.g., "mit, khanacademy.org")
    - REJECT any URL containing these strings (substring match)
    - This overrides all other filtering
    
    Resource Types (if {desired_resource_types} provided):
    - ONLY search for specified types:
      * "textbooks" ‚Üí open_textbook
      * "practice_problem_sets" ‚Üí practice_problem, problem_set
      * "practice_exams_tests" ‚Üí practice_exam, test
      * "lecture_videos" ‚Üí video_lecture, lecture_series, educational_video
    - If empty: use priority order (practice problems > textbooks > course materials > videos > papers)

    **TOPIC MATCHING:**
    From course_analysis_task output, check search_priority:
    - "user_topics" ‚Üí Search ONLY user_specified_topics (e.g., "line integrals" not "vector calculus")
    - "general_topics" ‚Üí Search general_course_topics
    - Always verify subject_keywords match to prevent cross-discipline results
    - REJECT resources from different academic fields

    **SEARCH EXECUTION:**
    Use "Search the internet with Serper" tool:
    - Pass ONLY a string to search_query parameter (e.g., "statics practice problems MIT")
    - DO NOT pass dictionaries or complex objects
    - Perform 5-7 targeted searches with simple string queries
    - Add "site:[domain]" for targeted sites
    - Include USA university names (e.g., "MIT", "Stanford", "Berkeley")

    **QUALITY CRITERIA:**
    - USA-based institutions and platforms ONLY (non-negotiable)
    - Free and legal access (no login required)
    - NotebookLM compatible (PDF/web/YouTube)
    - Match course level (from course_analysis_task)
    - Prioritize text-based content

    Inputs: {targeted_sites}, {excluded_sites}, {desired_resource_types}, course_analysis_task output

  expected_output: >
    List of 5-7 resources from USA sources only, each containing:
    
    - resource_title: Full title
    - resource_type: open_textbook | video_lecture | lecture_series | practice_problem | 
      course_notes | educational_video | problem_set | practice_exam
    - url: Direct link (accessible without login)
    - coverage_topics: List of topics this resource addresses
    - source_credibility: USA-based origin (e.g., "MIT OpenCourseWare", "OpenStax")
    - content_scope: comprehensive | supplementary | topic-specific
    - access_notes: Confirmation of free, legal, open access
    - estimated_depth: introductory | intermediate | advanced
    - alignment_with_book: How resource complements the course material
    - selection_rationale: Brief explanation of why included

    Format as structured JSON or clear text for downstream parsing.

  agent: resource_discovery_agent


resource_validation_task:
  description: >
    Validate resources from resource_discovery_agent for quality, accessibility, and relevance.

    **VALIDATION WORKFLOW (IN ORDER):**
    
    1. USER EXCLUSIONS (First - fastest check)
       - If {excluded_sites} provided, parse as comma-separated domains
       - REJECT any URL containing excluded strings (substring match)
       - Set rejection_reason="User excluded domain: [domain]"
       - Skip all other checks for excluded resources
    
    2. KNOWN PLATFORM AUTO-REJECT (Second - no API calls needed)
       REJECT these platforms immediately:
       - Khan Academy (khanacademy.org) - requires login
       - Coursera (coursera.org) - requires account
       - Udemy (udemy.com) - paid
       - edX (edx.org) - requires account
       - Udacity (udacity.com) - requires account
       - Brilliant.org - paid subscription
       - Course platforms: *.thinkific.com, *.teachable.com, *.podia.com
       
       REJECT URLs containing: "/premium/", "/pro/", "/subscription/", "/members-only/"
    
    3. METADATA-BASED VALIDATION (Third - no API calls)
       Use resource_title, coverage_topics, source_credibility from resource_search_task:
       
       a) Topic Relevance:
          - Verify coverage_topics match course subject_keywords
          - REJECT if clearly different discipline (stats for calculus, art history for Renaissance history)
          - Set relevance_score=0 for wrong subject
       
       b) URL Format Check:
          - PDFs must end in .pdf
          - YouTube must contain youtube.com or youtu.be
          - Verify URL structure is complete (no truncation)
          - LibreTexts: Must have full path like "math.libretexts.org/Bookshelves/Calculus/[book]/[chapter]/[section]"
          - MIT OCW: Must follow "ocw.mit.edu/courses/[dept]/[number]-[name]-[term]-[year]/"
          - OpenStax: Use "openstax.org/books/[book-name]" not "/details/books/"
          - REJECT incomplete or truncated URLs
       
       c) NotebookLM Compatibility:
          - Check file extension and resource_type
          - Compatible: PDF, YouTube, standard web pages
          - Incompatible: Interactive sites, login-required, proprietary formats
       
       d) Source Credibility:
          - Verify from URL domain and source_credibility field
          - Trusted: MIT OCW, OpenStax, US university domains (.edu)
    
    4. WEB VERIFICATION (Last - only if needed, minimize API calls)
       Only use web search for:
       - Suspicious/uncommon URL patterns
       - Personal faculty pages (e.g., "utsa.edu/kalra/...")
       - Unknown platforms (search "site:[domain] requires login")
       - Ambiguous titles (use 1-2 calls maximum)
       
       DO NOT use web search for:
       - Well-known platforms (MIT OCW, OpenStax, YouTube)
       - Resources already validated by metadata
       - PDFs from trusted sources
       
       Web search queries:
       - "[exact URL]" to verify existence
       - "site:[domain] [title]" to verify page
       - "site:[domain] requires login" for unknown platforms

    **SCORING (1-10):**
    - Relevance (40%): Matches course topics and level
    - Comprehensiveness (30%): Coverage scope
    - Credibility (20%): Source reputation
    - Usability (10%): Accessibility and format
    - MUST set score=0 if wrong subject area

    **EFFICIENCY RULES:**
    - Check exclusions and known platforms FIRST (no API calls)
    - Validate from metadata whenever possible
    - Use web search sparingly (1-2 calls per resource maximum)
    - Batch reject resources that fail early checks

    Inputs: {excluded_sites}, resources from resource_search_task

  expected_output: >
    **Approved Resources (5-7 target):**
    For each approved resource:
    - All original fields from resource_search_task
    - validation_status: "approved"
    - notebooklm_compatible: true | false
    - notebooklm_format: pdf | youtube | webpage | not_compatible
    - license_info: Copyright/license status if found
    - usefulness_score: 1-10
    - validation_notes: Important notes or warnings
    
    **Rejected Resources (summary only):**
    - resource_title
    - url
    - rejection_reason: Specific reason for rejection
    
    **Summary:**
    - Total validated: X
    - Approved: X
    - Rejected: X
    - Average usefulness score: X.X
    - Note if fewer than 5 resources approved

    Format as structured JSON. Only include full details for APPROVED resources.

  agent: resource_validator_agent

final_output_task:
  description: >
    Create a student-friendly resource guide formatted for NotebookLM use.

    **WORKFLOW:**
    1. Extract course and textbook information from course_analysis_task
    2. Remove any invalid resources (final safety check)
    3. Organize approved resources by type or topic
    4. Format as clear, encouraging markdown document
    5. Include NotebookLM usage instructions

    **FINAL SAFETY CHECK:**
    Before formatting, REMOVE any resources containing these domains:
    - khanacademy.org, coursera.org, udemy.com, edx.org, udacity.com, brilliant.org
    - Any URL containing these strings (substring match)
    - Do NOT include these in final output

    **DOCUMENT STRUCTURE:**
    
    1. Textbook Information (from course_analysis_task):
       - If textbook_title and textbook_author exist: display both with textbook_source
       - If missing: state "No textbook information was found for this course"
    
    2. Course Overview:
       - Brief 2-3 sentence description of course scope
       - Key topics from general_course_topics
       - If user_specified_topics exist: add note like "Resources focus on your specified topics: [list]"
    
    3. Recommended Resources:
       - Organize by topic area or resource type
       - Include all fields from validated resources
       - Use clear formatting with clickable URLs
       - Show usefulness scores
    
    4. NotebookLM Instructions:
       - Step-by-step for PDFs, YouTube videos, web pages
       - Clear, beginner-friendly language
    
    5. Study Tips:
       - How to use multiple sources effectively
       - NotebookLM feature recommendations
       - Workflow suggestions

    **FORMATTING REQUIREMENTS:**
    - Use markdown with clear headers (##, ###)
    - Clickable URLs in standard markdown format
    - Bullet points for lists
    - Emoji for visual appeal (üìö, üéØ, üì•, üí°)
    - Target length: 2-4 pages
    - Tone: Encouraging, clear, action-oriented

    Inputs: course_analysis_task output, validated resources from resource_validator_agent

  expected_output: >
    Formatted markdown document:

    # Study Resources for [Course Name]

    ## Textbook Information
    **Textbook:** [Title]
    **Author:** [Author(s)]
    **Source:** [course_page | user_provided]

    *(Omit section if no textbook found)*

    ---

    ## üìö Course Overview
    [2-3 sentence description]

    **Key Topics:**
    - [Topic 1]
    - [Topic 2]
    - [Topic 3]

    *(If user_specified_topics exist, add note about focused search)*

    ---

    ## üéØ Recommended Resources

    I've found [X] high-quality, free resources to supplement your learning:

    ### [Topic Area or Resource Type]

    **1. [Resource Title]** ([Type])
    - **Link:** [URL]
    - **What it covers:** [Description]
    - **Best for:** [Usage guidance]
    - **Usefulness Score:** ‚≠êÔ∏è [X/10]

    **2. [Next Resource]**
    [Same format]

    *(Continue for all resources, organized logically)*

    ---

    ## üì• How to Add These to NotebookLM

    **For PDFs:**
    1. Click the link to open the PDF
    2. In NotebookLM, click "+ New Source"
    3. Select "Upload" and choose the PDF file

    **For YouTube Videos:**
    1. Copy the YouTube URL
    2. In NotebookLM, click "+ New Source"
    3. Select "YouTube URL" and paste the link

    **For Web Pages:**
    1. Copy the webpage URL
    2. In NotebookLM, click "+ New Source"
    3. Select "Website URL" and paste the link

    ---

    ## üí° Study Tips

    **Using Multiple Sources:**
    - Compare explanations from different resources
    - Use textbook for theory, practice problems for application
    - Watch videos for visual explanations of complex topics

    **Maximizing NotebookLM:**
    - Use chat to ask questions across all sources
    - Generate study guides from multiple perspectives
    - Create flashcards from combined knowledge base
    - Use audio overview to hear key concepts explained

    ---

    **Total Resources:** [X] carefully vetted, free, and legal educational materials

    **Need More Help?** Try searching your university's course website or library for additional materials.

    ---

    *All resources are freely and legally accessible. No pirated content included.*

  agent: output_formatter_agent