course_analysis_task:
  description: >
    Analyze course page to extract textbook information, topics, and resource URLs.

    **PRIMARY OBJECTIVE:**
    Extract textbook title and author from the course page - this is MANDATORY for downstream agents.

    **DEFINITION ‚Äì OFFICIAL COURSE PAGE:**
    "Official course page" = a page whose primary content is the description,
    syllabus, or logistics of the specific course (title + number), not a
    department home page, news page, event listing, or general program overview.

    If a fetched page only contains department-wide info, news, events, conferences,
    or generic program descriptions and does not clearly describe the specific
    course (matching course_name and/or course_number), treat it as NOT the course
    page and keep searching.

    **WORKFLOW:**

    1. If course_name and university_name are provided (no URL):
       - Use web search to find the official course page URL.
       - Construct search queries that combine:
         - The exact course_name (including number if present), and
         - The university_name, and
         - Words like "course description", "class description", "syllabus",
           or "course catalog".
       - From the search results, collect several candidate URLs (top 5‚Äì10 results).
       - For each candidate, quickly check the title and snippet:
         - Prefer pages that:
           - Come from the university's own domains (e.g., *.edu or the
             university‚Äôs official domain), and
           - Include the course number or code in the URL path or page title, and
           - Mention "course description", "syllabus", "class description",
             "course catalog", or similar phrases.
         - Avoid selecting pages that are clearly department home pages, news pages,
           event listings, or general program pages (titles with only department
           names, "News", "Events", "Conference", etc.).
       - Choose the single best candidate as course_url before fetching the page.

    2. Check for user-provided textbook information:
       - If {book_title} and {book_author} are provided:
         - Use those as the primary textbook and set textbook_source="user_provided".
       - If {isbn} is provided:
         - Search for book info using the ISBN to confirm or fill missing metadata.
       - If {book_pdf_path} or {book_url} is provided:
         - Note these for downstream agents (they may use them as sources).
       - If {textbook} input is provided:
         - Parse it for title/author information and reconcile with any page data.

    3. Fetch course page content (if course_url is provided or found):
       - Use "Webpage Content Fetcher" on course_url.
       - FIRST, verify this is a true course page:
         - It should contain the course title and/or course number and a
           description or syllabus for this specific course.
         - If it only contains department-wide information, news, or conferences
           and no specific course details, treat it as NOT the course page and
           return to step 1 to search for a better URL (once).
       - Once a true course page is confirmed, search for textbook information in
         sections like:
         - "Materials", "Textbook", "Required Text", "Required Textbook",
           "Course Materials", "Resources".
       - Common textbook formats:
         - "Title, Author"
         - "Title by Author"
         - "Title (Author)"
         - Multi-line listing where title and author are on adjacent lines.
       - Parse into separate textbook_title and textbook_author fields.

    4. Extract syllabus (if present on course page):
       - Identify syllabus links (HTML or PDF), converting relative URLs to
         absolute URLs.
       - Fetch the syllabus ONCE using "Webpage Content Fetcher" (HTML or PDF).
       - Treat the syllabus as authoritative for textbook info and course scope.

    5. Determine topics (priority order):
       - If user provided topics_list ‚Üí use as primary focus (user_specified_topics).
       - Extract topics from syllabus schedule/outline (shows actual course coverage).
       - Extract topics from course description and any listed learning objectives.
       - Cross-reference textbook table of contents (if available) with the syllabus
         to identify only the chapters/sections actually covered.
       - Be specific:
         - If the syllabus or page says "Chapters 3‚Äì7", map to the corresponding
           chapter titles, not every chapter in the book.

    6. Extract all resource URLs:
       - List all links to lecture notes, problem sets, exams, videos, and other
         course resources found on the course page and syllabus.
       - DO NOT navigate to these linked resources (prevents redirect loops).
       - These URLs will be used by downstream resource search and validation agents.

    **DEPTH RESTRICTION:**
    - Navigate ONLY to:
      - Main course page, and
      - Syllabus (if found).
    - Extract but do not navigate to other resource links.

    **ERROR HANDLING AND VALIDATION:**
    - If the course page is not accessible:
      - Halt with a clear message explaining the issue.
    - If no textbook is found on the course page or syllabus and no user-provided
      textbook information is available:
      - Set textbook_source="not_found" and continue with topic extraction.
    - If zero topics AND no textbook AND no description can be determined:
      - Return an error asking the user to provide topics_list or a textbook PDF/URL.
    - Validation:
      - At least one of (user_topics, general_course_topics, textbook_title)
        must exist in the final output.

    Inputs: {university_name}, {course_name}, {course_url}, {textbook}, {topics_list},
            {book_title}, {book_author}, {isbn}, {book_pdf_path}, {book_url},
            {desired_resource_types}, {targeted_sites}

  expected_output: >
    JSON object containing:

    **Required fields:**
    - course_title: Course name from page (or null if not clearly found).
    - course_number: Course code (or null if not clearly found).
    - textbook_title: Full title (null if not found).
    - textbook_author: Author(s) (null if not found).
    - textbook_source: "course_page" | "user_provided" | "not_found".
    - search_priority: "user_topics" | "general_topics" based on presence of topics_list.

    **Topic fields:**
    - user_specified_topics: Array of topics from topics_list input (empty array if none).
    - general_course_topics: Array of topics extracted from syllabus/course materials.
    - subject_keywords: Descriptive keywords for the subject area / discipline.

    **Optional fields:**
    - textbook_edition: Edition if specified.
    - textbook_isbn: ISBN if found.
    - syllabus_url: URL of the syllabus if found.
    - resource_urls: List of all resource links found on the course page/syllabus.
    - course_level: "introductory" | "intermediate" | "advanced" if inferable.

    Format as a clean JSON object or clearly structured text that subsequent
    agents can easily parse.

  agent: course_intelligence_agent


resource_search_task:
  description: >
    Search for 5-7 high-quality resources from USA-based institutions matching the course topics.

    **USER-TARGETED SITES (HIGH PRIORITY):**
    Check the {targeted_sites} input parameter. If provided, PRIORITIZE resources from domains in this list.
    - Parse targeted_sites as comma-separated domain names (e.g., "stanford.edu, berkeley.edu, myschool.edu")
    - When searching, add "site:[domain]" to your search queries to find resources from these specific sites
    - Example: If user specified "stanford.edu", search "statics practice problems site:stanford.edu"
    - Try to find at least 2-3 resources from targeted sites if they exist and match the course topics
    - This is useful when students want resources from their own institution or specific universities
    - If no quality resources found from targeted sites, proceed with general search

    **USER-EXCLUDED SITES (CRITICAL):**
    Check the {excluded_sites} input parameter. If provided, REJECT any resource from domains in this list.
    - Parse excluded_sites as comma-separated domain names (e.g., "mit, khanacademy.org, coursera.org")
    - REJECT any URL containing ANY of these domain strings (substring match - e.g., "mit" will match "ocw.mit.edu", "mit.edu", etc.)
    - Examples: "mit" excludes "ocw.mit.edu", "khanacademy.org" excludes "www.khanacademy.org", "coursera" excludes "coursera.org"
    - This takes precedence over all other filtering - if user excluded a site, never include it

    **TOPIC MATCHING - CRITICAL:** Check search_priority from course_analysis_task output:
    - **IF search_priority = "user_topics":** Focus EXCLUSIVELY on user_specified_topics. Search for resources specifically covering those topics.
      Example: User specified "line integrals, surface integrals" ‚Üí search "line integrals practice problems" and "surface integrals tutorial", NOT general "vector calculus"
    - **IF search_priority = "general_topics":** Search for resources covering the general_course_topics
    - Always verify resources match the course's subject_keywords to avoid cross-discipline contamination
    - REJECT any resource from a different academic field (e.g., don't match statistics resources for a calculus course, don't match biology resources for a history course)
    - Verify the course title/description matches the subject area before including it

    **USA ONLY:** Only include resources from US universities, institutions, and platforms.

    **RESOURCE TYPE FILTERING:** Check {desired_resource_types} input.
    - If provided (non-empty list), ONLY search for matching types:
      * "textbooks" ‚Üí resource_type="open_textbook"
      * "practice_problem_sets" ‚Üí resource_type="practice_problem" or "problem_set"
      * "practice_exams_tests" ‚Üí resource_type="practice_exam" or "test"
      * "lecture_videos" ‚Üí resource_type="video_lecture" or "lecture_series" or "educational_video"
    - If empty/null, use priority order: (1) Practice problems, (2) Open textbooks, (3) Course materials, (4) Platform content, (5) Papers

    **SEARCH TOOL USAGE - CRITICAL:**
    You have access to "Search the internet with Serper" tool. 
    - Call the tool with ONLY a string value for search_query parameter
    - Example: search_query="statics practice problems MIT"
    - DO NOT pass dictionaries, objects, or complex structures
    - DO NOT pass description, metadata, or other fields - ONLY the search_query string
    - Perform 5-7 targeted searches, each with a simple string query

    **QUALITY:** Free, legal, US sources only. NotebookLM compatible (PDF/web/YouTube). Prioritize text-based content. Match course level.

    Use course_analysis_task output to guide searches.
  expected_output: >
    A curated list of 5-7 recommended resources that complement the student's book, each containing:
    
    - resource_title: Full title of the resource
    - resource_type: "open_textbook" | "video_lecture" | "lecture_series" | 
      "interactive_tutorial" | "course_notes" | "educational_video"
    - url: Direct link to the resource (must be accessible without login)
    - coverage_topics: List of book topics/chapters this resource addresses
    - source_credibility: Origin (e.g., "MIT OpenCourseWare", "OpenStax", "Khan Academy")
    - content_scope: "comprehensive" | "supplementary" | "topic-specific"
    - access_notes: Confirmation that it's free, legal, and openly accessible
    - estimated_depth: "introductory" | "intermediate" | "advanced"
    - alignment_with_book: Brief note on how this resource aligns with the book's structure

    Organize resources clearly. Include brief reasoning for why each resource was selected
    and how it complements the student's book.
  agent: resource_discovery_agent

resource_validation_task:
  description: >
    Validate resources from resource_discovery_agent for quality, legal, and technical requirements.

    **USER-EXCLUDED SITES (CRITICAL - FIRST CHECK):**
    Check the {excluded_sites} input parameter. If provided, REJECT any resource from domains in this list.
    - Parse excluded_sites as comma-separated domain names (e.g., "mit, khanacademy.org, coursera.org")
    - REJECT any URL containing ANY of these domain strings (substring match - e.g., "mit" will match "ocw.mit.edu", "mit.edu", etc.)
    - Examples: "mit" excludes "ocw.mit.edu", "khanacademy.org" excludes "www.khanacademy.org", "coursera" excludes "coursera.org"
    - Set rejection_reason to "User excluded domain: [domain]"
    - This is the FIRST validation check - do this before any other validation

    **CRITICAL - URL VALIDATION USING WEB SEARCH:**
    Before validating any resource, you MUST verify each URL actually exists and is accessible:
    1. For EVERY resource URL, perform a web search query: "[exact URL]" OR "site:[domain] [page title]"
    2. Check if the search results show the page exists and is accessible
    3. REJECT immediately if:
       - Search results show 404 errors or "page not found"
       - No search results found for the exact URL
       - Search results indicate the page was removed or moved
       - Domain doesn't exist or returns errors
    4. This prevents returning dead/broken links to users

    **CHECKS (EFFICIENT - MINIMIZE API CALLS):**
    1. URL format check: Verify URL structure (PDFs end in .pdf, YouTube URLs contain youtube.com, etc.)
    2. **URL ACCESSIBILITY (CRITICAL):** For web resources, verify the URL is actually valid:
       - Check for common 404 patterns and incomplete URLs
       - REJECT any URL that appears truncated or incomplete (e.g., ends abruptly without proper path)
       - LibreTexts URLs: Must be complete paths like "math.libretexts.org/Bookshelves/Calculus/Calculus_(OpenStax)/[chapter]/[section]"
         * REJECT if URL ends with incomplete path like "/Calculus_(OpenStax" or "/Bookshelves/Calculus/Calculus_(OpenStax"
         * Must have full chapter and section path to be valid
       - OpenStax: Use URLs like "openstax.org/books/[book-name]" NOT "openstax.org/details/books/[book-name]"
       - MIT OCW: Verify URLs follow pattern "ocw.mit.edu/courses/[department]/[course-number]-[course-name]-[semester]-[year]/"
         * REJECT incomplete MIT OCW URLs that don't include full course path
       - Personal/Faculty PDFs: Be extra cautious - many faculty members remove old course materials
         * For URLs like "utsa.edu/kalra/..." or similar personal faculty pages, perform web search to verify still exists
         * REJECT if web search shows 404 or page not found
       - Udacity, Coursera, edX: REJECT ALL (require accounts)
       - If URL looks suspicious, incomplete, or uses an uncommon format, perform a quick web search to verify the correct URL
       - Reject resources with clearly broken, incomplete, or non-existent URLs
    3. **LOGIN/PAYMENT REQUIREMENTS (CRITICAL - AUTO-REJECT):**
       **Always reject these known platforms:**
       - Khan Academy (khanacademy.org): REJECT - requires login
       - Coursera (coursera.org): REJECT - requires account
       - Udemy (udemy.com): REJECT - paid
       - edX (edx.org): REJECT - requires account
       - Udacity (udacity.com): REJECT - requires account
       - Brilliant.org: REJECT - paid subscription
       - Course platforms (*.thinkific.com, *.teachable.com, *.podia.com): REJECT

       **URL pattern checks - reject if URL contains:**
       - "/premium/", "/pro/", "/subscription/", "/members-only/"
       - Any indication of paid/restricted content

       **General check for unknown platforms:**
       For resources from domains you're unsure about, perform a quick web search:
       - Search: "site:[domain] requires login" OR "site:[domain] free access"
       - If results indicate login/payment required ‚Üí REJECT
       - If results show it's free and publicly accessible ‚Üí APPROVE
    4. NotebookLM compatibility: Check format from URL extension and resource_type (PDF/web/YouTube)
    5. Source credibility: Verify from URL domain and source_credibility field (MIT OCW, OpenStax, etc.)
    6. **TOPIC RELEVANCE (CRITICAL):** Resource MUST match the course subject area
       - PRIMARY: Use resource_title, coverage_topics, and source_credibility from previous task to verify relevance
       - ONLY use WebsiteSearchTool if absolutely necessary (e.g., title is ambiguous) - LIMIT to 1-2 calls maximum
       - For PDFs: Verify from URL, title, and source - DO NOT use WebsiteSearchTool on PDFs
       - For YouTube: Verify from video title and channel - DO NOT use WebsiteSearchTool unless title is unclear
       - For web pages: Only use WebsiteSearchTool if title/topics don't clearly indicate relevance
       - For Vector Calculus course ‚Üí REJECT probability, statistics, or unrelated math resources
       - For Renaissance History course ‚Üí REJECT modern history, art history, or unrelated humanities resources
       - Most validation should be done from metadata already provided, not by making additional API calls

    **REMOVE:** Requires payment/login, pirated, broken links, low quality, incompatible, OR WRONG SUBJECT AREA.

    **SCORE:** Rate usefulness 1-10: relevance (40%), comprehensiveness (30%), credibility (20%), usability (10%).
    - Relevance score MUST be 0 if the resource is for a different academic field or discipline

    Use resources from previous task.
  expected_output: >
    A filtered and validated list of resources, each containing:
    
    - All original resource fields from the search task
    - validation_status: "approved" | "rejected"
    - rejection_reason: Detailed explanation if rejected
    - notebooklm_compatible: true | false
    - notebooklm_format: "pdf" | "youtube" | "webpage" | "not_compatible"
    - license_info: Copyright/license information found
    - accessibility_verified: true | false
    - usefulness_score: 1-10 (integer)
    - validation_notes: Any important notes about the resource
    
    **Summary Statistics:**
    - Total resources validated: X
    - Approved: X
    - Rejected: X
    - Average usefulness score: X.X
    
    Only include APPROVED resources in the final list. Aim for 5-7 high-quality 
    approved resources total. If fewer than 5 pass validation, note this in the output.
  agent: resource_validator_agent

final_output_task:
  description: >
    Create student-friendly resource guide for NotebookLM use.

    **FINAL SAFETY CHECK - REMOVE INVALID RESOURCES:**
    Before formatting output, perform a FINAL check to remove any resources with these domains:
    - khanacademy.org (or any URL containing "khanacademy")
    - coursera.org (or any URL containing "coursera")
    - udemy.com (or any URL containing "udemy")
    - edx.org (or any URL containing "edx")
    - udacity.com (or any URL containing "udacity")
    - brilliant.org (or any URL containing "brilliant")
    REMOVE these resources entirely from the final output. DO NOT include them.

    **STRUCTURE:**
    1. Textbook info - Extract from course_analysis_task output:
       - Use textbook_title and textbook_author fields if present
       - Use textbook_source to indicate where it was found
       - If textbook info is missing, note that no textbook was specified
    2. Course overview (description, topics)
    3. **IF user_specified_topics were provided:** Add a clear note that resources were specifically searched for those topics (e.g., "These resources focus on your specified topics: line integrals, surface integrals")
    4. Resources (organized by type/topic, with URLs, descriptions, topics covered)
    5. NotebookLM instructions (how to add PDFs/videos/web pages)
    6. Study tips (workflow, features)

    **FORMAT:** Clear headers, clickable URLs, bullet points, 2-4 pages. Tone: encouraging, clear, action-oriented.

    **CRITICAL:** Check the course_analysis_task output for textbook_title and textbook_author fields. If they exist, include them in the Textbook Information section. If they don't exist, state "No textbook information was found."

    Use validated resources and course analysis from previous tasks.
  expected_output: >
    A formatted markdown document ready to present to the student:

    # Study Resources for [Course Name]

    ## Textbook Information
    **Textbook:** [Book Title]
    **Author:** [Author Name(s)]
    **Source:** [Where found - e.g., "Course Page", "User Provided"]

    (If no textbook found, omit this section)

    ---

    ## üìö Course Overview
    [2-3 sentence description of what this course covers and what students will learn]

    **Key Topics:**
    - Topic 1
    - Topic 2
    - Topic 3
    [etc.]

    ---
    
    ## üéØ Recommended Resources
    
    I've found [X] high-quality, free resources to supplement your learning:
    
    ### [Topic Area 1] or [Resource Type 1]
    
    **1. [Resource Title]** (Type: Textbook/Video/etc.)
    - **Link:** [Direct URL]
    - **What it covers:** [Brief description highlighting value]
    - **Best for:** [When/how to use this resource]
    - **Usefulness Score:** ‚≠êÔ∏è [X/10]
    
    **2. [Next resource]**
    [Same format]
    
    ### [Topic Area 2] or [Resource Type 2]
    [Continue...]
    
    ---
    
    ## üì• How to Add These to NotebookLM
    
    **For PDFs:**
    1. Click the link to open the PDF
    2. In NotebookLM, click "+ New Source"
    3. Select "Upload" and choose the PDF file
    
    **For YouTube Videos:**
    1. Copy the YouTube URL
    2. In NotebookLM, click "+ New Source"
    3. Select "YouTube URL" and paste the link
    
    **For Web Pages:**
    1. Copy the webpage URL
    2. In NotebookLM, click "+ New Source"
    3. Select "Website URL" and paste the link
    
    ---
    
    ## üí° Study Tips
    
    **Using Multiple Sources:**
    - [Tip 1]
    - [Tip 2]
    - [Tip 3]
    
    **Maximizing NotebookLM:**
    - Use the chat feature to ask questions across all sources
    - Generate study guides from multiple perspectives
    - Create flashcards from the combined knowledge base
    - Use the audio overview feature to hear key concepts explained
    
    ---
    
    **Total Resources:** [X] carefully vetted, free, and legal educational materials
    
    **Need More Help?** [Optional: suggestions for finding additional resources]
    
    ---
    
    *All resources are freely and legally accessible. No pirated content included.*
  agent: output_formatter_agent