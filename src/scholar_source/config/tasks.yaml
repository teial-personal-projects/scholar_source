course_analysis_task:
  description: >
    Analyze course/book info to identify academic discipline and topics. CRITICAL: correctly identify field to prevent off-topic resources.

    **DEPTH RESTRICTION - VERY IMPORTANT:**
    - ONLY navigate to the main course page URL provided by the user
    - If a syllabus link is found on the main page, you MAY navigate to that ONE additional link (syllabi often contain textbook and topic info)
    - DO NOT navigate to any other links (lecture notes, assignments, problem sets, etc.) to avoid redirect loops
    - However, DO extract and list ALL resource URLs found on the course page and syllabus (lecture notes, problem sets, exams, videos, etc.)
    - These extracted URLs will be used by other agents to find relevant study materials
    - This prevents infinite redirect loops while still capturing all course resources

    **VALIDATION:** If course_url provided, use WebsiteSearchTool with website={course_url} and search_query="textbook" to access content. If book_url provided, use WebsiteSearchTool similarly. If neither accessible, return "ERROR: Cannot access provided resources."

    **EXTRACTION:**
    1. Course page textbook extraction - CRITICAL: 
       - Use WebsiteSearchTool MULTIPLE times with different search queries to ensure you capture all content:
         * First: website={course_url}, search_query="Textbook"
         * Second: website={course_url}, search_query="Text:"  
         * Third: website={course_url}, search_query="Required Text"
         * Fourth: website={course_url}, search_query="Course Materials"
         * Fifth: website={course_url}, search_query="" (empty string to get full page content)
       - The textbook info appears as: "Textbook:" (label) followed by the book info on same or next line
       - EXACT format example: "Textbook:\nEngineering Mechanics: Statics, Bedford, Fowler"
       - Look for ANY text that contains book titles and author names together
       - Common patterns: "Textbook: [Title], [Author1], [Author2]" or "Text: [Title] by [Author]"
       - Extract the COMPLETE text that follows "Textbook:" or "Text:" labels
       - Parse: Everything before the first comma is usually the title, everything after is author(s)
       - Example: "Engineering Mechanics: Statics, Bedford, Fowler" ‚Üí title="Engineering Mechanics: Statics", authors="Bedford, Fowler"
       - If you see author names like "Bedford" or "Fowler" anywhere in the results, look for nearby book titles
       - CRITICAL: If ANY WebsiteSearchTool call returns content containing both a book title and author names, you MUST extract them
       - Don't give up if first query doesn't work - the empty string query ("") will return full page content
       - Also look for syllabus links (may be relative URLs like "../documents/syllabus.pdf")
    2. Syllabus: If you find a syllabus link, convert relative URLs to absolute URLs using the course page domain. You may visit the syllabus ONCE if it's an HTML page (skip PDFs). Extract textbook info and topics from syllabus.
    3. Textbook ToC: If you found a textbook title and author, search web for "[title] [author] table of contents" to get chapter topics.
    4. Topics:
       - **IF user provided topics_list:** Use those topics as PRIMARY focus. Still identify general course subject, but mark user topics as the priority search targets.
       - **IF NO topics_list:** Combine topics from course description, syllabus, textbook ToC to get comprehensive list. Even if limited info, extract what's available (e.g., "Statics", "Linear Algebra", "Vector Methods").
       - Always include both user_specified_topics (if any) and general_course_topics in output so downstream agents know what to prioritize.

    **ERROR IF:** Zero topics AND no textbook found AND no course description ‚Üí "ERROR: Cannot determine course topics. Provide textbook PDF or topics list."

    **IMPORTANT:** If you find the textbook but limited topic information, that's OK. Extract what's available from the course description (e.g., "Statics", "Linear Algebra") and proceed. The resource discovery agent will use the textbook ToC to find more detailed topics.

    **WEBSITESEARCHTOOL USAGE:** Call with website parameter set to the full URL (e.g., website="https://www.mccormick.northwestern.edu/civil-environmental/academics/courses/descriptions/GEN_ENG%20205-2.html") and search_query parameter set to what you're looking for (e.g., search_query="textbook").

    **IMPORTANT:** Only use WebsiteSearchTool on HTML pages (URLs ending in .html, .htm, .php, or no file extension). DO NOT use it on PDF files (.pdf), images (.jpg, .png), or other binary files. If you encounter binary data or an error, skip that URL and continue.

    Inputs: {university_name}, {course_name}, {course_url}, {textbook}, {topics_list}, {book_title}, {book_author}, {isbn}, {book_pdf_path}, {book_url}, {desired_resource_types}
  expected_output: >
    A structured analysis containing:

    - course_title: The course name from the course page (e.g., "Engineering Analysis II")
    - course_number: The course number (e.g., "GEN_ENG 205-2")
    - textbook_title: Full textbook title (e.g., "Engineering Mechanics: Statics") - REQUIRED if found on page
    - textbook_author: Author name(s) (e.g., "Bedford, Fowler") - REQUIRED if found on page
    - textbook_edition: Edition if specified (e.g., "5th edition")
    - textbook_isbn: ISBN if found
    - textbook_source: Where textbook info came from ("course_page", "user_provided", "not_found")
    - syllabus_url: URL to syllabus if found on course page
    - user_specified_topics: Topics from user's topics_list input (e.g., ["line integrals", "surface integrals"]) - EMPTY if not provided
    - general_course_topics: Comprehensive list of ALL topics from textbook ToC, syllabus, course page
      (e.g., ["Vectors", "Forces", "Systems of Forces and Moments", "Equilibrium", "Structures",
      "Centroids", "Centers of Mass", "Moments of Inertia", "Friction", "Internal Forces", "Virtual Work"])
    - search_priority: "user_topics" if user_specified_topics is non-empty, otherwise "general_topics"
    - course_level: "introductory" | "intermediate" | "advanced" | "professional"
    - subject_keywords: List of keywords describing the subject based on topics (e.g., ["statics", "mechanics", "forces", "equilibrium"])

    **CRITICAL OUTPUT REQUIREMENT:**
    After running ALL WebsiteSearchTool queries, examine the results for textbook information:
    - Look for book titles containing colons (e.g., "Engineering Mechanics: Statics")
    - Look for author last names (e.g., "Bedford", "Fowler")
    - If you see BOTH together (e.g., "Engineering Mechanics: Statics, Bedford, Fowler"), parse into separate fields
    - Split by first comma: everything before = title, everything after = author(s)
    - You MUST output textbook_title and textbook_author if found, even if format is ambiguous
    - If uncertain about parsing, include both fields with your best interpretation
    - These fields are CRITICAL for the frontend display

    Format as a clean JSON object or structured text that subsequent agents can easily parse.
  agent: course_intelligence_agent

resource_search_task:
  description: >
    Search for 5-7 high-quality resources from USA-based institutions matching the course topics.

    **TOPIC MATCHING - CRITICAL:** Check search_priority from course_analysis_task output:
    - **IF search_priority = "user_topics":** Focus EXCLUSIVELY on user_specified_topics. Search for resources specifically covering those topics.
      Example: User specified "line integrals, surface integrals" ‚Üí search "line integrals practice problems" and "surface integrals tutorial", NOT general "vector calculus"
    - **IF search_priority = "general_topics":** Search for resources covering the general_course_topics
    - Always verify resources match the course's subject_keywords to avoid cross-discipline contamination
    - REJECT any resource from a different academic field (e.g., don't match statistics resources for a calculus course, don't match biology resources for a history course)
    - Verify the course title/description matches the subject area before including it

    **USA ONLY:** Only include resources from US universities, institutions, and platforms.

    **RESOURCE TYPE FILTERING:** Check {desired_resource_types} input.
    - If provided (non-empty list), ONLY search for matching types:
      * "textbooks" ‚Üí resource_type="open_textbook"
      * "practice_problem_sets" ‚Üí resource_type="practice_problem" or "problem_set"
      * "practice_exams_tests" ‚Üí resource_type="practice_exam" or "test"
      * "lecture_videos" ‚Üí resource_type="video_lecture" or "lecture_series" or "educational_video"
    - If empty/null, use priority order: (1) Practice problems, (2) Open textbooks, (3) Course materials, (4) Platform content, (5) Papers

    **SEARCH TOOL USAGE - CRITICAL:**
    You have access to "Search the internet with Serper" tool. 
    - Call the tool with ONLY a string value for search_query parameter
    - Example: search_query="statics practice problems MIT"
    - DO NOT pass dictionaries, objects, or complex structures
    - DO NOT pass description, metadata, or other fields - ONLY the search_query string
    - Perform 5-7 targeted searches, each with a simple string query

    **QUALITY:** Free, legal, US sources only. NotebookLM compatible (PDF/web/YouTube). Prioritize text-based content. Match course level.

    Use course_analysis_task output to guide searches.
  expected_output: >
    A curated list of 5-7 recommended resources that complement the student's book, each containing:
    
    - resource_title: Full title of the resource
    - resource_type: "open_textbook" | "video_lecture" | "lecture_series" | 
      "interactive_tutorial" | "course_notes" | "educational_video"
    - url: Direct link to the resource (must be accessible without login)
    - coverage_topics: List of book topics/chapters this resource addresses
    - source_credibility: Origin (e.g., "MIT OpenCourseWare", "OpenStax", "Khan Academy")
    - content_scope: "comprehensive" | "supplementary" | "topic-specific"
    - access_notes: Confirmation that it's free, legal, and openly accessible
    - estimated_depth: "introductory" | "intermediate" | "advanced"
    - alignment_with_book: Brief note on how this resource aligns with the book's structure

    Organize resources clearly. Include brief reasoning for why each resource was selected
    and how it complements the student's book.
  agent: resource_discovery_agent

resource_validation_task:
  description: >
    Validate resources from resource_discovery_agent for quality, legal, and technical requirements.

    **CHECKS:**
    1. URL accessible, no paywalls/login
    2. NotebookLM compatible (PDF/web/YouTube)
    3. Legal/licensed (no pirated content)
    4. **TOPIC RELEVANCE (CRITICAL):** Resource MUST match the course subject area. Use WebsiteSearchTool to check the actual content.
       - ONLY use WebsiteSearchTool on HTML web pages (not PDFs, images, or binary files)
       - For PDF resources, verify relevance from the URL, title, and source instead of trying to read content
       - For Vector Calculus course ‚Üí REJECT probability, statistics, or unrelated math resources
       - For Renaissance History course ‚Üí REJECT modern history, art history, or unrelated humanities resources
       - Verify course titles, topics, and descriptions match before approving

    **REMOVE:** Requires payment/login, pirated, broken links, low quality, incompatible, OR WRONG SUBJECT AREA.

    **SCORE:** Rate usefulness 1-10: relevance (40%), comprehensiveness (30%), credibility (20%), usability (10%).
    - Relevance score MUST be 0 if the resource is for a different academic field or discipline

    Use resources from previous task.
  expected_output: >
    A filtered and validated list of resources, each containing:
    
    - All original resource fields from the search task
    - validation_status: "approved" | "rejected"
    - rejection_reason: Detailed explanation if rejected
    - notebooklm_compatible: true | false
    - notebooklm_format: "pdf" | "youtube" | "webpage" | "not_compatible"
    - license_info: Copyright/license information found
    - accessibility_verified: true | false
    - usefulness_score: 1-10 (integer)
    - validation_notes: Any important notes about the resource
    
    **Summary Statistics:**
    - Total resources validated: X
    - Approved: X
    - Rejected: X
    - Average usefulness score: X.X
    
    Only include APPROVED resources in the final list. Aim for 5-7 high-quality 
    approved resources total. If fewer than 5 pass validation, note this in the output.
  agent: resource_validator_agent

final_output_task:
  description: >
    Create student-friendly resource guide for NotebookLM use.

    **STRUCTURE:**
    1. Textbook info - Extract from course_analysis_task output:
       - Use textbook_title and textbook_author fields if present
       - Use textbook_source to indicate where it was found
       - If textbook info is missing, note that no textbook was specified
    2. Course overview (description, topics)
    3. **IF user_specified_topics were provided:** Add a clear note that resources were specifically searched for those topics (e.g., "These resources focus on your specified topics: line integrals, surface integrals")
    4. Resources (organized by type/topic, with URLs, descriptions, topics covered)
    5. NotebookLM instructions (how to add PDFs/videos/web pages)
    6. Study tips (workflow, features)

    **FORMAT:** Clear headers, clickable URLs, bullet points, 2-4 pages. Tone: encouraging, clear, action-oriented.

    **CRITICAL:** Check the course_analysis_task output for textbook_title and textbook_author fields. If they exist, include them in the Textbook Information section. If they don't exist, state "No textbook information was found."

    Use validated resources and course analysis from previous tasks.
  expected_output: >
    A formatted markdown document ready to present to the student:

    # Study Resources for [Course Name]

    ## Textbook Information
    **Textbook:** [Book Title]
    **Author:** [Author Name(s)]
    **Source:** [Where found - e.g., "Course Page", "User Provided"]

    (If no textbook found, omit this section)

    ---

    ## üìö Course Overview
    [2-3 sentence description of what this course covers and what students will learn]

    **Key Topics:**
    - Topic 1
    - Topic 2
    - Topic 3
    [etc.]

    ---
    
    ## üéØ Recommended Resources
    
    I've found [X] high-quality, free resources to supplement your learning:
    
    ### [Topic Area 1] or [Resource Type 1]
    
    **1. [Resource Title]** (Type: Textbook/Video/etc.)
    - **Link:** [Direct URL]
    - **What it covers:** [Brief description highlighting value]
    - **Best for:** [When/how to use this resource]
    - **Usefulness Score:** ‚≠êÔ∏è [X/10]
    
    **2. [Next resource]**
    [Same format]
    
    ### [Topic Area 2] or [Resource Type 2]
    [Continue...]
    
    ---
    
    ## üì• How to Add These to NotebookLM
    
    **For PDFs:**
    1. Click the link to open the PDF
    2. In NotebookLM, click "+ New Source"
    3. Select "Upload" and choose the PDF file
    
    **For YouTube Videos:**
    1. Copy the YouTube URL
    2. In NotebookLM, click "+ New Source"
    3. Select "YouTube URL" and paste the link
    
    **For Web Pages:**
    1. Copy the webpage URL
    2. In NotebookLM, click "+ New Source"
    3. Select "Website URL" and paste the link
    
    ---
    
    ## üí° Study Tips
    
    **Using Multiple Sources:**
    - [Tip 1]
    - [Tip 2]
    - [Tip 3]
    
    **Maximizing NotebookLM:**
    - Use the chat feature to ask questions across all sources
    - Generate study guides from multiple perspectives
    - Create flashcards from the combined knowledge base
    - Use the audio overview feature to hear key concepts explained
    
    ---
    
    **Total Resources:** [X] carefully vetted, free, and legal educational materials
    
    **Need More Help?** [Optional: suggestions for finding additional resources]
    
    ---
    
    *All resources are freely and legally accessible. No pirated content included.*
  agent: output_formatter_agent