course_analysis_task:
  description: >
    Analyze course page to extract textbook information, topics, and resource URLs.

    **PRIMARY OBJECTIVE:**
    Extract textbook title and author from the course page - this is MANDATORY for downstream agents.

    **DEFINITION ‚Äì OFFICIAL COURSE PAGE:**
    "Official course page" = a page whose primary content is the description,
    syllabus, or logistics of the specific course (title + number), not a
    department home page, news page, event listing, or general program overview.

    If a fetched page only contains department-wide info, news, events, conferences,
    or generic program descriptions and does not clearly describe the specific
    course (matching course_name and/or course_number), treat it as NOT the course
    page and keep searching.

    **WORKFLOW:**

    1. If course_name and university_name are provided (no URL):
       - Use web search to find the official course page URL.
       - Construct search queries that combine:
         - The exact course_name (including number if present), and
         - The university_name, and
         - Words like "course description", "class description", "syllabus",
           or "course catalog".
       - From the search results, collect several candidate URLs (top 5‚Äì10 results).
       - For each candidate, quickly check the title and snippet:
         - Prefer pages that:
           - Come from the university's own domains (e.g., *.edu or the
             university‚Äôs official domain), and
           - Include the course number or code in the URL path or page title, and
           - Mention "course description", "syllabus", "class description",
             "course catalog", or similar phrases.
         - Avoid selecting pages that are clearly department home pages, news pages,
           event listings, or general program pages (titles with only department
           names, "News", "Events", "Conference", etc.).
       - Choose the single best candidate as course_url before fetching the page.

    2. Check for user-provided textbook information:
       - If {book_title} and {book_author} are provided:
         - Use those as the primary textbook and set textbook_source="user_provided".
       - If {isbn} is provided:
         - Search for book info using the ISBN to confirm or fill missing metadata.
       - If {book_pdf_path} or {book_url} is provided:
         - Note these for downstream agents (they may use them as sources).
       - If {textbook} input is provided:
         - Parse it for title/author information and reconcile with any page data.

    3. Fetch course page content (if course_url is provided or found):
       - Use "Webpage Content Fetcher" on course_url.
       - FIRST, verify this is a true course page:
         - It should contain the course title and/or course number and a
           description or syllabus for this specific course.
         - If it only contains department-wide information, news, or conferences
           and no specific course details, treat it as NOT the course page and
           return to step 1 to search for a better URL (once).
       - Once a true course page is confirmed, search for textbook information in
         sections like:
         - "Materials", "Textbook", "Required Text", "Required Textbook",
           "Course Materials", "Resources".
       - Common textbook formats:
         - "Title, Author"
         - "Title by Author"
         - "Title (Author)"
         - Multi-line listing where title and author are on adjacent lines.
       - Parse into separate textbook_title and textbook_author fields.

    4. Extract syllabus (if present on course page):
       - Identify syllabus links (HTML or PDF), converting relative URLs to
         absolute URLs.
       - Fetch the syllabus ONCE using "Webpage Content Fetcher" (HTML or PDF).
       - Treat the syllabus as authoritative for textbook info and course scope.

    5. Determine topics (priority order):
       - If user provided topics_list ‚Üí use as primary focus (user_specified_topics).
       - Extract topics from syllabus schedule/outline (shows actual course coverage).
       - Extract topics from course description and any listed learning objectives.
       - Cross-reference textbook table of contents (if available) with the syllabus
         to identify only the chapters/sections actually covered.
       - Be specific:
         - If the syllabus or page says "Chapters 3‚Äì7", map to the corresponding
           chapter titles, not every chapter in the book.

    6. Extract all resource URLs:
       - List all links to lecture notes, problem sets, exams, videos, and other
         course resources found on the course page and syllabus.
       - DO NOT navigate to these linked resources (prevents redirect loops).
       - These URLs will be used by downstream resource search and validation agents.

    **DEPTH RESTRICTION:**
    - Navigate ONLY to:
      - Main course page, and
      - Syllabus (if found).
    - Extract but do not navigate to other resource links.

    **ERROR HANDLING AND VALIDATION:**
    - If the course page is not accessible:
      - Halt with a clear message explaining the issue.
    - If no textbook is found on the course page or syllabus and no user-provided
      textbook information is available:
      - Set textbook_source="not_found" and continue with topic extraction.
    - If zero topics AND no textbook AND no description can be determined:
      - Return an error asking the user to provide topics_list or a textbook PDF/URL.
    - Validation:
      - At least one of (user_topics, general_course_topics, textbook_title)
        must exist in the final output.

    Inputs: {university_name}, {course_name}, {course_url}, {textbook}, {topics_list},
            {book_title}, {book_author}, {isbn}, {book_pdf_path}, {book_url},
            {desired_resource_types}, {targeted_sites}

  expected_output: >
    JSON object containing:

    **Required fields:**
    - course_title: Course name from page (or null if not clearly found).
    - course_number: Course code (or null if not clearly found).
    - textbook_title: Full title (null if not found).
    - textbook_author: Author(s) (null if not found).
    - textbook_source: "course_page" | "user_provided" | "not_found".
    - search_priority: "user_topics" | "general_topics" based on presence of topics_list.

    **Topic fields:**
    - user_specified_topics: Array of topics from topics_list input (empty array if none).
    - general_course_topics: Array of topics extracted from syllabus/course materials.
    - subject_keywords: Descriptive keywords for the subject area / discipline.

    **Optional fields:**
    - textbook_edition: Edition if specified.
    - textbook_isbn: ISBN if found.
    - syllabus_url: URL of the syllabus if found.
    - resource_urls: List of all resource links found on the course page/syllabus.
    - course_level: "introductory" | "intermediate" | "advanced" if inferable.

    Format as a clean JSON object or clearly structured text that subsequent
    agents can easily parse.

  agent: course_intelligence_agent


resource_search_task:
  description: >
    Search for 5-7 high-quality resources from USA-based sources matching the course topics and user preferences.

    **WORKFLOW:**
    1. Parse user filters from inputs
    2. Determine search focus from course_analysis_task output
    3. Execute targeted searches (USA sources only)
    4. Filter and validate results (reject non-USA sources)
    5. Return curated list

    **USA-ONLY REQUIREMENT:**
    ALL resources must be from USA-based institutions, universities, or platforms.
    - Accept: MIT, Stanford, Berkeley, OpenStax, US university sites
    - REJECT: Cambridge.ac.uk, Oxford.ac.uk, any non-US institution
    - When searching, include USA university names or add "USA" to queries
    - Verify domain and institution location before including any resource

    **PLATFORM RESTRICTIONS (DO NOT SEARCH OR INCLUDE):**
    NEVER include resources from these platforms (require login/payment):
    - Khan Academy (khanacademy.org) - requires login
    - Coursera (coursera.org) - requires account
    - Udemy (udemy.com) - paid courses
    - edX (edx.org) - requires account
    - Udacity (udacity.com) - requires account
    - Brilliant.org - paid subscription
    - Course platforms: *.thinkific.com, *.teachable.com, *.podia.com
    
    REJECT any URL containing: /premium/, /pro/, /subscription/, /members-only/
    
    Only recommend publicly accessible resources with NO login or payment required.

    **USER FILTERS (APPLY AFTER USA AND PLATFORM CHECKS):**
    
    Targeted Sites (if {targeted_sites} provided):
    - Parse as comma-separated domains (e.g., "stanford.edu, berkeley.edu")
    - Prioritize resources from these sites using "site:[domain]" in searches
    - Aim for 2-3 resources from targeted sites if quality matches
    
    Excluded Sites (if {excluded_sites} provided):
    - Parse as comma-separated domains (e.g., "mit, khanacademy.org")
    - REJECT any URL containing these strings (substring match)
    - This overrides all other filtering
    
    Resource Types (if {desired_resource_types} provided):
    - ONLY search for specified types:
      * "textbooks" ‚Üí open_textbook
      * "practice_problem_sets" ‚Üí practice_problem, problem_set
      * "practice_exams_tests" ‚Üí practice_exam, test
      * "lecture_videos" ‚Üí video_lecture, lecture_series, educational_video
    - If empty: use priority order (practice problems > textbooks > course materials > videos > papers)

    **TOPIC MATCHING:**
    From course_analysis_task output, check search_priority:
    - "user_topics" ‚Üí Search ONLY user_specified_topics (e.g., "line integrals" not "vector calculus")
    - "general_topics" ‚Üí Search general_course_topics
    - Always verify subject_keywords match to prevent cross-discipline results
    - REJECT resources from different academic fields

    **SEARCH EXECUTION:**
    Use "Search the internet with Serper" tool:
    - Pass ONLY a string to search_query parameter (e.g., "statics practice problems MIT")
    - DO NOT pass dictionaries or complex objects
    - Perform 5-7 targeted searches with simple string queries
    - Add "site:[domain]" for targeted sites
    - Include USA university names (e.g., "MIT", "Stanford", "Berkeley")

    **QUALITY CRITERIA:**
    - USA-based institutions and platforms ONLY (non-negotiable)
    - Free and legal access (no login required)
    - NotebookLM compatible (PDF/web/YouTube)
    - Match course level (from course_analysis_task)
    - Prioritize text-based content

    Inputs: {targeted_sites}, {excluded_sites}, {desired_resource_types}, course_analysis_task output

  expected_output: >
    List of 5-7 resources from USA sources only, each containing:
    
    - resource_title: Full title
    - resource_type: open_textbook | video_lecture | lecture_series | practice_problem | 
      course_notes | educational_video | problem_set | practice_exam
    - url: Direct link (accessible without login)
    - coverage_topics: List of topics this resource addresses
    - source_credibility: USA-based origin (e.g., "MIT OpenCourseWare", "OpenStax")
    - content_scope: comprehensive | supplementary | topic-specific
    - access_notes: Confirmation of free, legal, open access
    - estimated_depth: introductory | intermediate | advanced
    - alignment_with_book: How resource complements the course material
    - selection_rationale: Brief explanation of why included

    Format as structured JSON or clear text for downstream parsing.

  agent: resource_discovery_agent


resource_validation_task:
  description: >
    Validate resources from resource_discovery_agent for quality, accessibility, and relevance.

    **VALIDATION WORKFLOW (IN ORDER):**
    
    1. USER EXCLUSIONS (First - fastest check)
       - If {excluded_sites} provided, parse as comma-separated domains
       - REJECT any URL containing excluded strings (substring match)
       - Set rejection_reason="User excluded domain: [domain]"
       - Skip all other checks for excluded resources
    
    2. KNOWN PLATFORM AUTO-REJECT (Second - no API calls needed)
       REJECT these platforms immediately:
       - Khan Academy (khanacademy.org) - requires login
       - Coursera (coursera.org) - requires account
       - Udemy (udemy.com) - paid
       - edX (edx.org) - requires account
       - Udacity (udacity.com) - requires account
       - Brilliant.org - paid subscription
       - Course platforms: *.thinkific.com, *.teachable.com, *.podia.com
       
       REJECT URLs containing: "/premium/", "/pro/", "/subscription/", "/members-only/"
    
    3. METADATA-BASED VALIDATION (Third - no API calls)
       Use resource_title, coverage_topics, source_credibility from resource_search_task:
       
       a) Topic Relevance:
          - Verify coverage_topics match course subject_keywords
          - REJECT if clearly different discipline (stats for calculus, art history for Renaissance history)
          - Set relevance_score=0 for wrong subject
       
       b) URL Format Check:
          - PDFs must end in .pdf
          - YouTube must contain youtube.com or youtu.be
          - Verify URL structure is complete (no truncation)
          - LibreTexts: Must have full path like "math.libretexts.org/Bookshelves/Calculus/[book]/[chapter]/[section]"
          - MIT OCW: Must follow "ocw.mit.edu/courses/[dept]/[number]-[name]-[term]-[year]/"
          - OpenStax: Use "openstax.org/books/[book-name]" not "/details/books/"
          - REJECT incomplete or truncated URLs
       
       c) NotebookLM Compatibility:
          - Check file extension and resource_type
          - Compatible: PDF, YouTube, standard web pages
          - Incompatible: Interactive sites, login-required, proprietary formats
       
       d) Source Credibility:
          - Verify from URL domain and source_credibility field
          - Trusted: MIT OCW, OpenStax, US university domains (.edu)
    
    4. WEB VERIFICATION (Last - only if needed, minimize API calls)
       Only use web search for:
       - Suspicious/uncommon URL patterns
       - Personal faculty pages (e.g., "utsa.edu/kalra/...")
       - Unknown platforms (search "site:[domain] requires login")
       - Ambiguous titles (use 1-2 calls maximum)
       
       DO NOT use web search for:
       - Well-known platforms (MIT OCW, OpenStax, YouTube)
       - Resources already validated by metadata
       - PDFs from trusted sources
       
       Web search queries:
       - "[exact URL]" to verify existence
       - "site:[domain] [title]" to verify page
       - "site:[domain] requires login" for unknown platforms

    **SCORING (1-10):**
    - Relevance (40%): Matches course topics and level
    - Comprehensiveness (30%): Coverage scope
    - Credibility (20%): Source reputation
    - Usability (10%): Accessibility and format
    - MUST set score=0 if wrong subject area

    **EFFICIENCY RULES:**
    - Check exclusions and known platforms FIRST (no API calls)
    - Validate from metadata whenever possible
    - Use web search sparingly (1-2 calls per resource maximum)
    - Batch reject resources that fail early checks

    Inputs: {excluded_sites}, resources from resource_search_task

  expected_output: >
    **Approved Resources (5-7 target):**
    For each approved resource:
    - All original fields from resource_search_task
    - validation_status: "approved"
    - notebooklm_compatible: true | false
    - notebooklm_format: pdf | youtube | webpage | not_compatible
    - license_info: Copyright/license status if found
    - usefulness_score: 1-10
    - validation_notes: Important notes or warnings
    
    **Rejected Resources (summary only):**
    - resource_title
    - url
    - rejection_reason: Specific reason for rejection
    
    **Summary:**
    - Total validated: X
    - Approved: X
    - Rejected: X
    - Average usefulness score: X.X
    - Note if fewer than 5 resources approved

    Format as structured JSON. Only include full details for APPROVED resources.

  agent: resource_validator_agent

final_output_task:
  description: >
    Create a student-friendly resource guide formatted for NotebookLM use.

    **WORKFLOW:**
    1. Extract course and textbook information from course_analysis_task
    2. Remove any invalid resources (final safety check)
    3. Organize approved resources by type or topic
    4. Format as clear, encouraging markdown document
    5. Include NotebookLM usage instructions

    **FINAL SAFETY CHECK:**
    Before formatting, REMOVE any resources containing these domains:
    - khanacademy.org, coursera.org, udemy.com, edx.org, udacity.com, brilliant.org
    - Any URL containing these strings (substring match)
    - Do NOT include these in final output

    **DOCUMENT STRUCTURE:**
    
    1. Textbook Information (from course_analysis_task):
       - If textbook_title and textbook_author exist: display both with textbook_source
       - If missing: state "No textbook information was found for this course"
    
    2. Course Overview:
       - Brief 2-3 sentence description of course scope
       - Key topics from general_course_topics
       - If user_specified_topics exist: add note like "Resources focus on your specified topics: [list]"
    
    3. Recommended Resources:
       - Organize by topic area or resource type
       - Include all fields from validated resources
       - Use clear formatting with clickable URLs
       - Show usefulness scores
    
    4. NotebookLM Instructions:
       - Step-by-step for PDFs, YouTube videos, web pages
       - Clear, beginner-friendly language
    
    5. Study Tips:
       - How to use multiple sources effectively
       - NotebookLM feature recommendations
       - Workflow suggestions

    **FORMATTING REQUIREMENTS:**
    - Use markdown with clear headers (##, ###)
    - Clickable URLs in standard markdown format
    - Bullet points for lists
    - Emoji for visual appeal (üìö, üéØ, üì•, üí°)
    - Target length: 2-4 pages
    - Tone: Encouraging, clear, action-oriented

    Inputs: course_analysis_task output, validated resources from resource_validator_agent

  expected_output: >
    Formatted markdown document:

    # Study Resources for [Course Name]

    ## Textbook Information
    **Textbook:** [Title]
    **Author:** [Author(s)]
    **Source:** [course_page | user_provided]

    *(Omit section if no textbook found)*

    ---

    ## üìö Course Overview
    [2-3 sentence description]

    **Key Topics:**
    - [Topic 1]
    - [Topic 2]
    - [Topic 3]

    *(If user_specified_topics exist, add note about focused search)*

    ---

    ## üéØ Recommended Resources

    I've found [X] high-quality, free resources to supplement your learning:

    ### [Topic Area or Resource Type]

    **1. [Resource Title]** ([Type])
    - **Link:** [URL]
    - **What it covers:** [Description]
    - **Best for:** [Usage guidance]
    - **Usefulness Score:** ‚≠êÔ∏è [X/10]

    **2. [Next Resource]**
    [Same format]

    *(Continue for all resources, organized logically)*

    ---

    ## üì• How to Add These to NotebookLM

    **For PDFs:**
    1. Click the link to open the PDF
    2. In NotebookLM, click "+ New Source"
    3. Select "Upload" and choose the PDF file

    **For YouTube Videos:**
    1. Copy the YouTube URL
    2. In NotebookLM, click "+ New Source"
    3. Select "YouTube URL" and paste the link

    **For Web Pages:**
    1. Copy the webpage URL
    2. In NotebookLM, click "+ New Source"
    3. Select "Website URL" and paste the link

    ---

    ## üí° Study Tips

    **Using Multiple Sources:**
    - Compare explanations from different resources
    - Use textbook for theory, practice problems for application
    - Watch videos for visual explanations of complex topics

    **Maximizing NotebookLM:**
    - Use chat to ask questions across all sources
    - Generate study guides from multiple perspectives
    - Create flashcards from combined knowledge base
    - Use audio overview to hear key concepts explained

    ---

    **Total Resources:** [X] carefully vetted, free, and legal educational materials

    **Need More Help?** Try searching your university's course website or library for additional materials.

    ---

    *All resources are freely and legally accessible. No pirated content included.*

  agent: output_formatter_agent