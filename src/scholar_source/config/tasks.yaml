course_analysis_task:
  description: >
    Analyze course/book info to identify academic discipline and topics. CRITICAL: correctly identify field to prevent off-topic resources.

    **DEPTH RESTRICTION - VERY IMPORTANT:**
    - ONLY navigate to the main course page URL provided by the user
    - If a syllabus link is found on the main page, you MAY navigate to that ONE additional link (syllabi often contain textbook and topic info)
    - DO NOT navigate to any other links (lecture notes, assignments, problem sets, etc.) to avoid redirect loops
    - However, DO extract and list ALL resource URLs found on the course page and syllabus (lecture notes, problem sets, exams, videos, etc.)
    - These extracted URLs will be used by other agents to find relevant study materials
    - This prevents infinite redirect loops while still capturing all course resources

    **VALIDATION:** If course_url provided, use WebsiteSearchTool with website={course_url} and search_query="textbook syllabus course description" to access content. If book_url provided, use WebsiteSearchTool similarly. If neither accessible, return "ERROR: Cannot access provided resources."

    **EXTRACTION:**
    1. Course page: Use WebsiteSearchTool with website={course_url} and search_query="Textbook" or "Required Text" to find textbook info. Then search with search_query="Syllabus" or "Course Outline" for syllabus. Extract exact titles/authors/ISBNs.
    2. Syllabus ONLY: If you find a syllabus link on the main course page, you may visit it ONCE to extract textbook info and topics. Do not follow any other links from the syllabus.
    3. Textbook ToC: Search web for "[title] [author] table of contents" to get chapter topics.
    4. Topics:
       - **IF user provided topics_list:** Use those topics as PRIMARY focus. Still identify general course subject, but mark user topics as the priority search targets.
       - **IF NO topics_list:** Combine topics from course page, syllabus, textbook ToC to get comprehensive list.
       - Always include both user_specified_topics (if any) and general_course_topics in output so downstream agents know what to prioritize.

    **ERROR IF:** Zero topics from all sources ‚Üí "ERROR: Cannot determine course topics. Provide textbook PDF or topics list."

    **WEBSITESEARCHTOOL USAGE:** Call with website parameter set to the full URL (e.g., website="https://www.mccormick.northwestern.edu/civil-environmental/academics/courses/descriptions/GEN_ENG%20205-2.html") and search_query parameter set to what you're looking for (e.g., search_query="textbook").

    Inputs: {university_name}, {course_name}, {course_url}, {textbook}, {topics_list}, {book_title}, {book_author}, {isbn}, {book_pdf_path}, {book_url}, {desired_resource_types}
  expected_output: >
    A structured analysis containing:

    - course_title: The course name from the course page (e.g., "Engineering Analysis: Statics")
    - course_number: The course number (e.g., "GEN_ENG 205-2")
    - official_textbooks: Textbook title, author, edition, ISBN if found on course page
    - syllabus_url: URL to syllabus if found on course page
    - user_specified_topics: Topics from user's topics_list input (e.g., ["line integrals", "surface integrals"]) - EMPTY if not provided
    - general_course_topics: Comprehensive list of ALL topics from textbook ToC, syllabus, course page
      (e.g., ["Vectors", "Forces", "Systems of Forces and Moments", "Equilibrium", "Structures",
      "Centroids", "Centers of Mass", "Moments of Inertia", "Friction", "Internal Forces", "Virtual Work"])
    - search_priority: "user_topics" if user_specified_topics is non-empty, otherwise "general_topics"
    - course_level: "introductory" | "intermediate" | "advanced" | "professional"
    - textbook_source: Where textbook info came from ("course_page", "user_provided", "not_found")
    - subject_keywords: List of keywords describing the subject based on topics (e.g., ["statics", "mechanics", "forces", "equilibrium"])

    Format as a clean JSON object or structured text that subsequent agents can easily parse.
  agent: course_intelligence_agent

resource_search_task:
  description: >
    Search for 5-7 high-quality resources from USA-based institutions matching the course topics.

    **TOPIC MATCHING - CRITICAL:** Check search_priority from course_analysis_task output:
    - **IF search_priority = "user_topics":** Focus EXCLUSIVELY on user_specified_topics. Search for resources specifically covering those topics.
      Example: User specified "line integrals, surface integrals" ‚Üí search "line integrals practice problems" and "surface integrals tutorial", NOT general "vector calculus"
    - **IF search_priority = "general_topics":** Search for resources covering the general_course_topics
    - Always verify resources match the course's subject_keywords to avoid cross-discipline contamination
    - REJECT any resource from a different academic field (e.g., don't match statistics resources for a calculus course, don't match biology resources for a history course)
    - Verify the course title/description matches the subject area before including it

    **USA ONLY:** Only include resources from US universities, institutions, and platforms.

    **RESOURCE TYPE FILTERING:** Check {desired_resource_types} input.
    - If provided (non-empty list), ONLY search for matching types:
      * "textbooks" ‚Üí resource_type="open_textbook"
      * "practice_problem_sets" ‚Üí resource_type="practice_problem" or "problem_set"
      * "practice_exams_tests" ‚Üí resource_type="practice_exam" or "test"
      * "lecture_videos" ‚Üí resource_type="video_lecture" or "lecture_series" or "educational_video"
    - If empty/null, use priority order: (1) Practice problems, (2) Open textbooks, (3) Course materials, (4) Platform content, (5) Papers

    **SEARCH TOOL:** Use "Search the internet with Serper" with simple string queries like "statics practice problems MIT". Perform 5-7 targeted searches.

    **QUALITY:** Free, legal, US sources only. NotebookLM compatible (PDF/web/YouTube). Prioritize text-based content. Match course level.

    Use course_analysis_task output to guide searches.
  expected_output: >
    A curated list of 5-7 recommended resources that complement the student's book, each containing:
    
    - resource_title: Full title of the resource
    - resource_type: "open_textbook" | "video_lecture" | "lecture_series" | 
      "interactive_tutorial" | "course_notes" | "educational_video"
    - url: Direct link to the resource (must be accessible without login)
    - coverage_topics: List of book topics/chapters this resource addresses
    - source_credibility: Origin (e.g., "MIT OpenCourseWare", "OpenStax", "Khan Academy")
    - content_scope: "comprehensive" | "supplementary" | "topic-specific"
    - access_notes: Confirmation that it's free, legal, and openly accessible
    - estimated_depth: "introductory" | "intermediate" | "advanced"
    - alignment_with_book: Brief note on how this resource aligns with the book's structure

    Organize resources clearly. Include brief reasoning for why each resource was selected
    and how it complements the student's book.
  agent: resource_discovery_agent

resource_validation_task:
  description: >
    Validate resources from resource_discovery_agent for quality, legal, and technical requirements.

    **CHECKS:**
    1. URL accessible, no paywalls/login
    2. NotebookLM compatible (PDF/web/YouTube)
    3. Legal/licensed (no pirated content)
    4. **TOPIC RELEVANCE (CRITICAL):** Resource MUST match the course subject area. Use WebsiteSearchTool to check the actual content.
       - For Vector Calculus course ‚Üí REJECT probability, statistics, or unrelated math resources
       - For Renaissance History course ‚Üí REJECT modern history, art history, or unrelated humanities resources
       - Verify course titles, topics, and descriptions match before approving

    **REMOVE:** Requires payment/login, pirated, broken links, low quality, incompatible, OR WRONG SUBJECT AREA.

    **SCORE:** Rate usefulness 1-10: relevance (40%), comprehensiveness (30%), credibility (20%), usability (10%).
    - Relevance score MUST be 0 if the resource is for a different academic field or discipline

    Use resources from previous task.
  expected_output: >
    A filtered and validated list of resources, each containing:
    
    - All original resource fields from the search task
    - validation_status: "approved" | "rejected"
    - rejection_reason: Detailed explanation if rejected
    - notebooklm_compatible: true | false
    - notebooklm_format: "pdf" | "youtube" | "webpage" | "not_compatible"
    - license_info: Copyright/license information found
    - accessibility_verified: true | false
    - usefulness_score: 1-10 (integer)
    - validation_notes: Any important notes about the resource
    
    **Summary Statistics:**
    - Total resources validated: X
    - Approved: X
    - Rejected: X
    - Average usefulness score: X.X
    
    Only include APPROVED resources in the final list. Aim for 5-7 high-quality 
    approved resources total. If fewer than 5 pass validation, note this in the output.
  agent: resource_validator_agent

final_output_task:
  description: >
    Create student-friendly resource guide for NotebookLM use.

    **STRUCTURE:**
    1. Textbook info (title, author, source)
    2. Course overview (description, topics)
    3. **IF user_specified_topics were provided:** Add a clear note that resources were specifically searched for those topics (e.g., "These resources focus on your specified topics: line integrals, surface integrals")
    4. Resources (organized by type/topic, with URLs, descriptions, topics covered)
    5. NotebookLM instructions (how to add PDFs/videos/web pages)
    6. Study tips (workflow, features)

    **FORMAT:** Clear headers, clickable URLs, bullet points, 2-4 pages. Tone: encouraging, clear, action-oriented.

    Use validated resources and course analysis from previous tasks.
  expected_output: >
    A formatted markdown document ready to present to the student:
    
    # Study Resources for [Course Name]
    
    ## üìö Course Overview
    [2-3 sentence description of what this course covers and what students will learn]
    
    **Key Topics:**
    - Topic 1
    - Topic 2
    - Topic 3
    [etc.]
    
    ---
    
    ## üéØ Recommended Resources
    
    I've found [X] high-quality, free resources to supplement your learning:
    
    ### [Topic Area 1] or [Resource Type 1]
    
    **1. [Resource Title]** (Type: Textbook/Video/etc.)
    - **Link:** [Direct URL]
    - **What it covers:** [Brief description highlighting value]
    - **Best for:** [When/how to use this resource]
    - **Usefulness Score:** ‚≠êÔ∏è [X/10]
    
    **2. [Next resource]**
    [Same format]
    
    ### [Topic Area 2] or [Resource Type 2]
    [Continue...]
    
    ---
    
    ## üì• How to Add These to NotebookLM
    
    **For PDFs:**
    1. Click the link to open the PDF
    2. In NotebookLM, click "+ New Source"
    3. Select "Upload" and choose the PDF file
    
    **For YouTube Videos:**
    1. Copy the YouTube URL
    2. In NotebookLM, click "+ New Source"
    3. Select "YouTube URL" and paste the link
    
    **For Web Pages:**
    1. Copy the webpage URL
    2. In NotebookLM, click "+ New Source"
    3. Select "Website URL" and paste the link
    
    ---
    
    ## üí° Study Tips
    
    **Using Multiple Sources:**
    - [Tip 1]
    - [Tip 2]
    - [Tip 3]
    
    **Maximizing NotebookLM:**
    - Use the chat feature to ask questions across all sources
    - Generate study guides from multiple perspectives
    - Create flashcards from the combined knowledge base
    - Use the audio overview feature to hear key concepts explained
    
    ---
    
    **Total Resources:** [X] carefully vetted, free, and legal educational materials
    
    **Need More Help?** [Optional: suggestions for finding additional resources]
    
    ---
    
    *All resources are freely and legally accessible. No pirated content included.*
  agent: output_formatter_agent